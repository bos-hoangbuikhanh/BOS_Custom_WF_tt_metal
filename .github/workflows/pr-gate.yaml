name: PR Gate
on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  checks: write
  packages: write

jobs:
  find-changed-files:
    runs-on: ubuntu-latest
    outputs:
      any-code-changed: ${{ steps.find-changes.outputs.any-code-changed }}
      test-changed: ${{ steps.find-changes.outputs.test-changed }}
    steps:
      - id: find-changes
        uses: ./.github/actions/find-changed-files@main

  build:
    needs: find-changed-files
    if: ${{ needs.find-changed-files.outputs.any-code-changed == 'true' }}
    uses: ./.github/workflows/build-artifact.yaml
    with:
      build-type: Release
      build-wheel: true
      publish-artifact: true

  unit-tests:
    needs: [build, find-changed-files]
    if: ${{ needs.find-changed-files.outputs.any-code-changed == 'true' }}
    uses: ./.github/workflows/test-workflow.yaml
    with:
      build-artifact-name: ${{ needs.build.outputs.build-artifact-name }}
      wheel-artifact-name: ${{ needs.build.outputs.wheel-artifact-name }}

  workflow-status:
    name: PR Gate Status
    if: always()
    needs: [find-changed-files, build, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check if all jobs passed
        run: |
          echo "find-changed-files: ${{ needs.find-changed-files.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "unit-tests: ${{ needs.unit-tests.result }}"

          # If no code changed, build + unit-tests are skipped — treat as pass
          if [[ "${{ needs.find-changed-files.outputs.any-code-changed }}" != "true" ]]; then
            echo "✅ No code changed; checks skipped appropriately"
            exit 0
          fi

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi

          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "❌ Unit tests failed"
            exit 1
          fi

          echo "✅ All checks passed"
