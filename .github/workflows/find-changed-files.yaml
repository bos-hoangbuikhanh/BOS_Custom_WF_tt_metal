name: 'Find Changed Files'
description: 'Detects which files have changed'
inputs:
  base-ref:
    description: 'Base branch to compare against'
    required: false
    default: 'main'
outputs:
  any-code-changed:
    description: 'Whether any code files changed'
    value: ${{ steps.changes.outputs.any-code-changed }}
  test-changed:
    description: 'Whether test files changed'
    value: ${{ steps.changes.outputs.test-changed }}
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Find changed files
      id: changes
      shell: bash
      run: |
        set -euo pipefail

        git fetch origin "${{ inputs.base-ref }}" --depth=1 || true

        CHANGED_FILES=$(git diff --name-only "origin/${{ inputs.base-ref }}"...HEAD)

        ANY_CODE_CHANGED=false
        TEST_CHANGED=false

        while IFS= read -r file; do
          [[ -z "$file" ]] && continue
          if [[ "$file" =~ \.(py|js|ts|cpp|c|h|hpp|java|go|rs)$ ]]; then
            ANY_CODE_CHANGED=true
          fi
          if [[ "$file" =~ ^tests/ ]]; then
            TEST_CHANGED=true
          fi
        done <<< "$CHANGED_FILES"

        echo "any-code-changed=$ANY_CODE_CHANGED" >> "$GITHUB_OUTPUT"
        echo "test-changed=$TEST_CHANGED" >> "$GITHUB_OUTPUT"
